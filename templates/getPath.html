<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <title>장소 정보 및 경로 표시</title>
        <!-- JQuery를 import 합니다 -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.1/css/bulma.min.css" />
        <style type="text/css">
            body,
            html {
                margin: 0;
                padding: 0;
                height: 100%;
                width: 100%;
            }
            #container {
                width: 70%;
                margin: auto;
                display: flex;
                flex-direction: column;
                height: 100%;
                padding: 20px;
                box-sizing: border-box;
            }
            .info-item {
                margin: 10px 0;
            }
            #map {
                width: 90%;
                margin: auto;
                height: 90%;
                margin-top: 20px;
            }
            #infoBox {
                display: flex;
                align-items: center;
                justify-self: center;
                font-size: 20px;
            }
            #mapContainer {
                height: 70%;
            }
        </style>

        <script>
            var map; // 지도 객체를 전역 변수로 선언
            let currentLat, currentLon;
            var storedObjectString = localStorage.getItem('placeData');
            if (storedObjectString) {
                // JSON 문자열을 객체로 변환
                var myObject = JSON.parse(storedObjectString);
                var documents = myObject.data[0]['data'][0]; // 객체 출력: {name: 'John Doe', age: 30, email: 'john.doe@example.com'}
            }

            function initMap() {
                navigator.geolocation.getCurrentPosition(function (position) {
                    currentLat = position.coords.latitude; // 위도
                    currentLon = position.coords.longitude;
                    var mapContainer = document.getElementById('map'); // 지도를 표시할 div
                    var mapOption = {
                        center: new kakao.maps.LatLng(currentLat, currentLon), // 지도의 중심좌표
                        level: 3, // 지도의 확대 레벨
                    };
                    map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

                    showPlaceInfo();
                    displayRoute();
                });
            }

            function showPlaceInfo() {
                var place = documents;
                var infoHtml = `
                <div class="info-item cell"><img id="place-img" width="200"></div>
                <div id="infoBox" class="cell is-col-span-2">
                    <div>
                <div class="info-item has-text-black"><strong class="has-text-success">이름:</strong> ${place.place_name}</div>
                <div class="info-item has-text-black"><strong class="has-text-success">주소:</strong> ${place.address_name}</div>
                <div class="info-item has-text-black"><strong class="has-text-success">도로명 주소:</strong> ${place.road_address_name}</div>
                <div class="info-item has-text-black"><strong class="has-text-success">전화번호:</strong> ${place.phone}</div>
                <div class="info-item has-text-black"><strong class="has-text-success">카테고리:</strong> ${place.category_name}</div>
                    </div>
                </div>
            `;
                $('#place-info').html(infoHtml);

                // 이미지 검색 및 표시
                $.ajax({
                    type: 'GET',
                    url: 'https://dapi.kakao.com/v2/search/image',
                    data: { query: place.place_name },
                    headers: { Authorization: 'KakaoAK 03427ce08466c2fe4c4567485860e426' },
                    success: function (response) {
                        if (
                            response.documents &&
                            response.documents.length > 0 &&
                            response.documents[0].thumbnail_url
                        ) {
                            $('#place-img').attr('src', response.documents[0].thumbnail_url);
                        } else {
                            $('#place-img').attr('alt', '이미지를 찾을 수 없습니다.');
                        }
                    },
                    error: function () {
                        $('#place-img').attr('alt', '이미지를 불러오는 중 오류가 발생했습니다.');
                    },
                });
            }

            function displayRoute() {
                var destination = documents;
                $.ajax({
                    type: 'GET',
                    url: `https://apis-navi.kakaomobility.com/v1/directions?origin=${currentLon},${currentLat}&destination=${destination.x},${destination.y}&waypoints=&priority=RECOMMEND&car_fuel=GASOLINE&car_hipass=false&alternatives=false&road_details=false`,
                    headers: { Authorization: 'KakaoAK 4bf7de4f9df1b1781420b6e75ae8324a' },
                    success: function (response) {
                        let linePath = [];
                        let result = response.routes[0].sections[0].roads;

                        for (let i = 0; i < result.length; i++) {
                            for (let j = 0; j < result[i].vertexes.length; j++) {
                                if (j % 2 == 0) {
                                    linePath.push(
                                        new kakao.maps.LatLng(result[i].vertexes[j + 1], result[i].vertexes[j])
                                    );
                                }
                            }
                        }
                        var polyline = new kakao.maps.Polyline({
                            path: linePath,
                            strokeWeight: 5,
                            strokeColor: '#000000',
                            strokeOpacity: 0.7,
                            strokeStyle: 'solid',
                        });
                        polyline.setMap(map);
                    },
                });
            }
            localStorage.removeItem('placeData');
        </script>
    </head>

    <body onload="initMap()">
        <div id="container" class="has-background-white-ter">
            <div id="place-info" class="grid is-column-gap-5"></div>

            <hr />
            <div id="mapContainer" class="has-background-primary-30">
                <div id="map"></div>
            </div>

            <script
                type="text/javascript"
                src="//dapi.kakao.com/v2/maps/sdk.js?appkey=ceb3b1d27e47ea6a83b6caea96944e4e&libraries=services,clusterer,drawing"
            ></script>
        </div>
    </body>
</html>
